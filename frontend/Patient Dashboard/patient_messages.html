<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages | Patient Dashboard</title>
    <link rel="stylesheet" href="css/patient_dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Adding index.html-consistent colors */
        :root {
            --primary-color: #1A76D1;
            --secondary-color: #0c5aa9;
            --accent-color: #ffa500;
        }
        
        .sidebar {
            background-color: #2c3e50;
        }
        
        .btn-primary, .pagination-btn.page.active {
            background-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .section-header h2 {
            color: var(--primary-color);
        }
        
        /* Messaging Styles */
        .messaging-container {
            display: flex;
            min-height: 500px;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background-color: white;
        }
        
        .contacts-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
        }
        
        .contacts-header {
            padding: 15px;
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .contact-search {
            padding: 10px;
            background: #f1f3f5;
        }
        
        .contact-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .contact-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .contact-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .contact-item:hover {
            background: #e9ecef;
        }
        
        .contact-item.active {
            background: #e2f0fd;
            border-left: 3px solid var(--primary-color);
        }
        
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .contact-role {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .unread-badge {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-recipient-info {
            display: flex;
            align-items: center;
        }
        
        .recipient-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .recipient-details h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .recipient-details .role {
            font-size: 12px;
            color: #6c757d;
        }
        
        .chat-actions .btn {
            font-size: 14px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .chat-actions .btn:hover {
            background-color: #e9ecef;
        }
        
        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            word-break: break-word;
        }
        
        .message.sent {
            background: #cce5ff;
            border-bottom-right-radius: 0;
            align-self: flex-end;
        }
        
        .message.received {
            background: #f1f3f5;
            border-bottom-left-radius: 0;
            align-self: flex-start;
        }
        
        .message-time {
            font-size: 11px;
            color: #6c757d;
            position: absolute;
            bottom: -18px;
            white-space: nowrap;
        }
        
        .message.sent .message-time {
            right: 5px;
        }
        
        .message.received .message-time {
            left: 5px;
        }
        
        .chat-footer {
            padding: 15px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            align-items: center;
        }
        
        .chat-footer textarea {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            resize: none;
            height: 40px;
            line-height: 20px;
            max-height: 100px;
        }
        
        .chat-footer button {
            margin-left: 10px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chat-footer button:hover {
            background: var(--secondary-color);
        }
        
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
        }
        
        .empty-chat i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #e9ecef;
        }
        
        .empty-chat-message {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .empty-chat-subtext {
            font-size: 14px;
            text-align: center;
            max-width: 300px;
        }
        
        .message-loader {
            text-align: center;
            padding: 20px 0;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h2>Nabad</h2>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="patient_dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="patient_appointments.html"><i class="fas fa-calendar-check"></i> My Appointments</a></li>
                <li><a href="patient_medical_records.html"><i class="fas fa-file-medical"></i> Medical Records</a></li>
                <li><a href="insurance-portal.html"><i class="fas fa-heartbeat"></i> Insurance</a></li>
                <li><a href="patient_messages.html"><i class="fas fa-envelope"></i> Messages</a></li>
                <li><a href="../index.html" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="search-container">
                    <input type="text" placeholder="Search...">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </div>
                <div class="user-profile">
                    <div class="notification">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </div>
                    <div class="profile">
                        <img src="img/patient-avatar.jpg" alt="Patient Avatar">
                        <div class="profile-info">
                            <p class="name">Ahmed Mohamed</p>
                            <p class="role">Patient</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard">
                <div class="section-header">
                    <h2>My Messages</h2>
                </div>
                
                <div class="messaging-container">
                    <!-- Contacts Sidebar -->
                    <div class="contacts-sidebar">
                        <div class="contacts-header">
                            Messages
                        </div>
                        <div class="contact-search">
                            <input type="text" placeholder="Search contacts..." id="contactSearchInput">
                        </div>
                        <ul class="contact-list" id="contactList">
                            <!-- Will be populated by JavaScript -->
                            <li class="contact-item" id="loading-contacts">
                                <div class="text-center w-100 py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <div class="mt-2">Loading contacts...</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Chat Area -->
                    <div class="chat-area">
                        <div id="emptyChatView" class="empty-chat">
                            <i class="fas fa-comments"></i>
                            <div class="empty-chat-message">Select a contact to start messaging</div>
                            <div class="empty-chat-subtext">You can message your doctors and nurses about non-urgent matters</div>
                        </div>
                        
                        <div id="chatView" style="display: none; flex-direction: column; height: 100%;">
                            <div class="chat-header">
                                <div class="chat-recipient-info">
                                    <div class="recipient-avatar" id="recipientAvatar">JD</div>
                                    <div class="recipient-details">
                                        <h4 id="recipientName">John Doe</h4>
                                        <div class="role" id="recipientRole">Doctor</div>
                                    </div>
                                </div>
                                <div class="chat-actions">
                                    <button class="btn" id="refreshChat">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="chat-body" id="chatBody">
                                <!-- Will be populated by JavaScript -->
                                <div class="message-loader">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <div class="mt-2">Loading messages...</div>
                                </div>
                            </div>
                            <div class="chat-footer">
                                <textarea id="messageInput" placeholder="Type a message..."></textarea>
                                <button id="sendButton">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/patient_messages.js"></script>
    <script>
        // Add logout functionality
        document.getElementById('logout-link').addEventListener('click', function(e) {
            // Clear authentication token on logout
            localStorage.removeItem('token');
            console.log('User logged out, token removed');
            // Continue to index page
        });
        
        // Global variables
        let currentUser = null;
        let currentRecipient = null;
        let contacts = [];
        let messages = [];
        const API_URL = 'http://localhost:5000';
        
        // DOM elements
        const contactList = document.getElementById('contactList');
        const emptyChatView = document.getElementById('emptyChatView');
        const chatView = document.getElementById('chatView');
        const chatBody = document.getElementById('chatBody');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const recipientName = document.getElementById('recipientName');
        const recipientRole = document.getElementById('recipientRole');
        const recipientAvatar = document.getElementById('recipientAvatar');
        const contactSearchInput = document.getElementById('contactSearchInput');
        const refreshChatButton = document.getElementById('refreshChat');
        
        // Init function that runs on page load
        async function initMessaging() {
            // For demo purposes, we'll use sample data
            // In a real app, you would fetch this from an API
            loadSampleData();
            setupEventListeners();
        }
        
        // Load sample data for demo
        function loadSampleData() {
            // Sample contacts data
            contacts = [
                { id: 1, name: 'Dr. Sarah Johnson', role: 'Cardiologist', unread_count: 3 },
                { id: 2, name: 'Dr. James Wilson', role: 'Neurologist', unread_count: 0 },
                { id: 3, name: 'Dr. Emily Chen', role: 'Dermatologist', unread_count: 1 },
                { id: 4, name: 'Nurse Roberts', role: 'Head Nurse', unread_count: 0 }
            ];
            
            // Remove loading indicator
            const loadingElement = document.getElementById('loading-contacts');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            // Display contacts
            renderContacts(contacts);
        }
        
        // Render contacts in sidebar
        function renderContacts(contactsArray) {
            if (contactsArray.length === 0) {
                contactList.innerHTML = `
                    <li class="contact-item text-center">
                        <div class="p-3">No contacts available</div>
                    </li>
                `;
                return;
            }
            
            contactList.innerHTML = '';
            contactsArray.forEach(contact => {
                const initials = getInitials(contact.name);
                const unreadCount = contact.unread_count || 0;
                
                const contactItem = document.createElement('li');
                contactItem.className = 'contact-item';
                contactItem.dataset.id = contact.id;
                contactItem.dataset.role = contact.role;
                contactItem.innerHTML = `
                    <div class="contact-avatar">${initials}</div>
                    <div>
                        <div>${contact.name}</div>
                        <div class="contact-role">${contact.role}</div>
                    </div>
                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                `;
                
                contactItem.addEventListener('click', () => selectContact(contact));
                contactList.appendChild(contactItem);
            });
        }
        
        // Select a contact to chat with
        function selectContact(contact) {
            currentRecipient = contact;
            
            // Update UI
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`.contact-item[data-id="${contact.id}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
                // Remove unread badge
                const unreadBadge = selectedItem.querySelector('.unread-badge');
                if (unreadBadge) {
                    unreadBadge.remove();
                }
            }
            
            // Update chat header
            recipientName.textContent = contact.name;
            recipientRole.textContent = contact.role;
            recipientAvatar.textContent = getInitials(contact.name);
            
            // Show chat view
            emptyChatView.style.display = 'none';
            chatView.style.display = 'flex';
            
            // Load messages
            loadSampleMessages(contact.id);
        }
        
        // Load sample messages for demo
        function loadSampleMessages(contactId) {
            chatBody.innerHTML = `
                <div class="message-loader">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <div class="mt-2">Loading messages...</div>
                </div>
            `;
            
            // Simulate loading delay
            setTimeout(() => {
                // Sample messages based on contact
                if (contactId === 1) {
                    messages = [
                        { id: 1, content: "Hello, Dr. Johnson. I've been experiencing chest pain after exercising.", is_sent: true, timestamp: "2023-05-10T10:30:00" },
                        { id: 2, content: "Hi Ahmed, could you describe the pain? Is it sharp or dull?", is_sent: false, timestamp: "2023-05-10T10:35:00" },
                        { id: 3, content: "It's a sharp pain, right in the center of my chest.", is_sent: true, timestamp: "2023-05-10T10:38:00" },
                        { id: 4, content: "How long does it last? Does it radiate to your arm or jaw?", is_sent: false, timestamp: "2023-05-10T10:40:00" },
                        { id: 5, content: "It lasts about 10 minutes and sometimes radiates to my left arm.", is_sent: true, timestamp: "2023-05-10T10:45:00" },
                        { id: 6, content: "I think we should schedule you for an in-person assessment. This could be angina. Please book an appointment as soon as possible.", is_sent: false, timestamp: "2023-05-10T10:50:00" }
                    ];
                } else if (contactId === 2) {
                    messages = [
                        { id: 1, content: "Dr. Wilson, I've been having frequent headaches since our last appointment.", is_sent: true, timestamp: "2023-05-05T14:20:00" },
                        { id: 2, content: "Are you taking the medication I prescribed?", is_sent: false, timestamp: "2023-05-05T15:30:00" },
                        { id: 3, content: "Yes, every day as directed.", is_sent: true, timestamp: "2023-05-05T15:45:00" },
                        { id: 4, content: "Let's schedule a follow-up to adjust your dosage.", is_sent: false, timestamp: "2023-05-05T16:00:00" }
                    ];
                } else if (contactId === 3) {
                    messages = [
                        { id: 1, content: "Dr. Chen, the rash has improved with the cream you prescribed.", is_sent: true, timestamp: "2023-05-08T09:10:00" },
                        { id: 2, content: "That's great news! Continue using it for another week as directed.", is_sent: false, timestamp: "2023-05-08T10:25:00" }
                    ];
                } else if (contactId === 4) {
                    messages = [
                        { id: 1, content: "Nurse Roberts, when should I come in for my next blood test?", is_sent: true, timestamp: "2023-05-09T11:00:00" },
                        { id: 2, content: "You're due for another test next Monday. You can come anytime between 8 AM and 4 PM.", is_sent: false, timestamp: "2023-05-09T11:30:00" },
                        { id: 3, content: "Do I need to fast before the test?", is_sent: true, timestamp: "2023-05-09T11:35:00" },
                        { id: 4, content: "Yes, please fast for 8 hours before the test. You can drink water.", is_sent: false, timestamp: "2023-05-09T11:40:00" },
                        { id: 5, content: "Thank you, I'll schedule for Monday morning.", is_sent: true, timestamp: "2023-05-09T11:45:00" }
                    ];
                } else {
                    messages = [];
                }
                
                // Display messages
                renderMessages(messages);
            }, 1000);
        }
        
        // Render messages in chat body
        function renderMessages(messagesArray) {
            chatBody.innerHTML = '';
            
            if (messagesArray.length === 0) {
                chatBody.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <i class="fas fa-comments" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <div>No messages yet</div>
                        <div style="font-size: 14px;">Start the conversation!</div>
                    </div>
                `;
                return;
            }
            
            messagesArray.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${msg.is_sent ? 'sent' : 'received'}`;
                messageElement.textContent = msg.content;
                
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = formatMessageTime(msg.timestamp);
                messageElement.appendChild(timeElement);
                
                chatBody.appendChild(messageElement);
            });
            
            // Scroll to bottom
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        // Send a message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentRecipient) return;
            
            // Create a new message
            const newMessage = {
                id: messages.length + 1,
                content: message,
                is_sent: true,
                timestamp: new Date().toISOString()
            };
            
            // Add to messages array
            messages.push(newMessage);
            
            // Clear input
            messageInput.value = '';
            
            // Re-render messages
            renderMessages(messages);
            
            // Auto-response for demo (simulate doctor response)
            setTimeout(() => {
                const autoResponse = {
                    id: messages.length + 1,
                    content: getAutoResponse(currentRecipient.id),
                    is_sent: false,
                    timestamp: new Date().toISOString()
                };
                messages.push(autoResponse);
                renderMessages(messages);
            }, 1500);
        }
        
        // Simple auto-response based on doctor
        function getAutoResponse(doctorId) {
            const responses = [
                "I'll review this information. Thank you.",
                "Thanks for the update. I'll note this in your chart.",
                "Let me know if your symptoms change.",
                "This is helpful information. Let's discuss this further at your next appointment.",
                "I've received your message and will follow up soon."
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // Filter contacts by search term
        function filterContacts(searchTerm) {
            const filtered = contacts.filter(contact => {
                return contact.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                       contact.role.toLowerCase().includes(searchTerm.toLowerCase());
            });
            renderContacts(filtered);
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Send message on button click
            sendButton.addEventListener('click', sendMessage);
            
            // Send message on Enter key (but allow Shift+Enter for new line)
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Filter contacts on search input
            contactSearchInput.addEventListener('input', (e) => {
                filterContacts(e.target.value);
            });
            
            // Refresh chat on button click
            refreshChatButton.addEventListener('click', () => {
                if (currentRecipient) {
                    loadSampleMessages(currentRecipient.id);
                }
            });
            
            // Auto-resize textarea
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
            });
        }
        
        // Helper function to get initials from a name
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }
        
        // Helper function to format message time
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            
            // Same day
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            // Yesterday
            else if (date.toDateString() === yesterday.toDateString()) {
                return `Yesterday, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            }
            // This week
            else if (now.getTime() - date.getTime() < 7 * 24 * 60 * 60 * 1000) {
                return `${date.toLocaleDateString([], { weekday: 'short' })}, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            }
            // Older
            else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initMessaging);
    </script>
</body>
</html>
