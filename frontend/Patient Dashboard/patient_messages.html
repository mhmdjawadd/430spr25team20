<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages | Patient Dashboard</title>
    <link rel="stylesheet" href="css/patient_dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Adding index.html-consistent colors */
        :root {
            --primary-color: #1A76D1;
            --secondary-color: #0c5aa9;
            --accent-color: #ffa500;
        }
        
        .sidebar {
            background-color: #2c3e50;
        }
        
        .btn-primary, .pagination-btn.page.active {
            background-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .section-header h2 {
            color: var(--primary-color);
        }
        
        /* Messaging Styles */
        .messaging-container {
            display: flex;
            min-height: 500px;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background-color: white;
        }
        
        .contacts-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
        }
        
        .contacts-header {
            padding: 15px;
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        .contact-search {
            padding: 10px;
            background: #f1f3f5;
        }
        
        .contact-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .contact-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .contact-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }
        
        .contact-item:hover {
            background: #e9ecef;
        }
        
        .contact-item.active {
            background: #e2f0fd;
            border-left: 3px solid var(--primary-color);
        }
        
        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .contact-role {
            font-size: 12px;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .unread-badge {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .chat-header {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-recipient-info {
            display: flex;
            align-items: center;
        }
        
        .recipient-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .recipient-details h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .recipient-details .role {
            font-size: 12px;
            color: #6c757d;
        }
        
        .chat-actions .btn {
            font-size: 14px;
            padding: 5px 10px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .chat-actions .btn:hover {
            background-color: #e9ecef;
        }
        
        .chat-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            position: relative;
            word-break: break-word;
        }
        
        .message.sent {
            background: #cce5ff;
            border-bottom-right-radius: 0;
            align-self: flex-end;
        }
        
        .message.received {
            background: #f1f3f5;
            border-bottom-left-radius: 0;
            align-self: flex-start;
        }
        
        .message-time {
            font-size: 11px;
            color: #6c757d;
            position: absolute;
            bottom: -18px;
            white-space: nowrap;
        }
        
        .message.sent .message-time {
            right: 5px;
        }
        
        .message.received .message-time {
            left: 5px;
        }
        
        .chat-footer {
            padding: 15px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            align-items: center;
        }
        
        .chat-footer textarea {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e9ecef;
            border-radius: 20px;
            resize: none;
            height: 40px;
            line-height: 20px;
            max-height: 100px;
        }
        
        .chat-footer button {
            margin-left: 10px;
            border: none;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chat-footer button:hover {
            background: var(--secondary-color);
        }
        
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
        }
        
        .empty-chat i {
            font-size: 60px;
            margin-bottom: 20px;
            color: #e9ecef;
        }
        
        .empty-chat-message {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .empty-chat-subtext {
            font-size: 14px;
            text-align: center;
            max-width: 300px;
        }
        
        .message-loader {
            text-align: center;
            padding: 20px 0;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <h2>Nabad</h2>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="patient_dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
                <li><a href="patient_appointments.html"><i class="fas fa-calendar-check"></i> My Appointments</a></li>
                <li><a href="patient_medical_records.html"><i class="fas fa-file-medical"></i> Medical Records</a></li>
                <li><a href="insurance-portal.html"><i class="fas fa-heartbeat"></i> Insurance</a></li>
                <li><a href="patient_messages.html"><i class="fas fa-envelope"></i> Messages</a></li>
                <li><a href="../index.html" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="search-container">
                    <input type="text" placeholder="Search...">
                    <button type="submit"><i class="fas fa-search"></i></button>
                </div>
                <div class="user-profile">
                    <div class="notification">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </div>
                    <div class="profile">
                        <img src="img/patient-avatar.jpg" alt="Patient Avatar">
                        <div class="profile-info">
                            <p class="name">Ahmed Mohamed</p>
                            <p class="role">Patient</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dashboard">
                <div class="section-header">
                    <h2>My Messages</h2>
                </div>
                
                <div class="messaging-container">
                    <!-- Contacts Sidebar -->
                    <div class="contacts-sidebar">
                        <div class="contacts-header">
                            Messages
                        </div>
                        <div class="contact-search">
                            <input type="text" placeholder="Search contacts..." id="contactSearchInput">
                        </div>
                        <ul class="contact-list" id="contactList">
                            <!-- Will be populated by JavaScript -->
                            <li class="contact-item" id="loading-contacts">
                                <div class="text-center w-100 py-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <div class="mt-2">Loading contacts...</div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Chat Area -->
                    <div class="chat-area">
                        <div id="emptyChatView" class="empty-chat">
                            <i class="fas fa-comments"></i>
                            <div class="empty-chat-message">Select a contact to start messaging</div>
                            <div class="empty-chat-subtext">You can message your doctors and nurses about non-urgent matters</div>
                        </div>
                        
                        <div id="chatView" style="display: none; flex-direction: column; height: 100%;">
                            <div class="chat-header">
                                <div class="chat-recipient-info">
                                    <div class="recipient-avatar" id="recipientAvatar">JD</div>
                                    <div class="recipient-details">
                                        <h4 id="recipientName">John Doe</h4>
                                        <div class="role" id="recipientRole">Doctor</div>
                                    </div>
                                </div>
                                <div class="chat-actions">
                                    <button class="btn" id="refreshChat">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="chat-body" id="chatBody">
                                <!-- Will be populated by JavaScript -->
                                <div class="message-loader">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <div class="mt-2">Loading messages...</div>
                                </div>
                            </div>
                            <div class="chat-footer">
                                <textarea id="messageInput" placeholder="Type a message..."></textarea>
                                <button id="sendButton">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/auth-api.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let currentRecipient = null;
        let contacts = [];
        let messages = [];
        const API_URL = 'http://localhost:5000';
        
        // DOM elements
        const contactList = document.getElementById('contactList');
        const emptyChatView = document.getElementById('emptyChatView');
        const chatView = document.getElementById('chatView');
        const chatBody = document.getElementById('chatBody');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const recipientName = document.getElementById('recipientName');
        const recipientRole = document.getElementById('recipientRole');
        const recipientAvatar = document.getElementById('recipientAvatar');
        const contactSearchInput = document.getElementById('contactSearchInput');
        const refreshChatButton = document.getElementById('refreshChat');
        
        // Add logout functionality
        document.getElementById('logout-link').addEventListener('click', function(e) {
            // Clear authentication token on logout
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            console.log('User logged out, token removed');
            // Continue to index page
        });
        
        // Init function that runs on page load
        async function initMessaging() {
            try {
                // Show UI right away
                setupEventListeners();
                
                // Try to load user data from localStorage with safer parsing
                let userData = {};
                try {
                    const userDataString = localStorage.getItem('user');
                    if (userDataString && userDataString !== "undefined") {
                        userData = JSON.parse(userDataString);
                    }
                } catch (err) {
                    console.warn('Error parsing user data from localStorage:', err);
                    // Default to empty object if parsing fails
                }
                
                if (userData && userData.first_name) {
                    currentUser = userData;
                    
                    // Update profile display
                    const nameElement = document.querySelector('.profile-info .name');
                    if (nameElement) {
                        nameElement.textContent = `${userData.first_name} ${userData.last_name || ''}`;
                    }
                }
                
                // Check for token regardless of whether we have user data
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('No authentication token found');
                    // Show message instead of error alert
                    contactList.innerHTML = `
                        <li class="contact-item text-center">
                            <div class="p-3">Please log in to view your messages</div>
                        </li>
                    `;
                    return;
                }
                
                // Load contacts first - most important for UI
                loadContacts().catch(err => {
                    console.warn('Error loading contacts, using sample data instead:', err);
                    loadSampleData();
                });
                
                // Try to fetch user profile only if we don't have it already - but don't block UI
                if (!currentUser || !currentUser.first_name) {
                    try {
                        const profileResponse = await fetch(`${API_URL}/user/profile`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            // Add a timeout to prevent hanging
                            signal: AbortSignal.timeout(5000)
                        });
                        
                        if (profileResponse.ok) {
                            const data = await profileResponse.json();
                            currentUser = data.user;
                            
                            // Save user data to localStorage
                            localStorage.setItem('user', JSON.stringify(data.user));
                            
                            // Update profile display
                            const nameElement = document.querySelector('.profile-info .name');
                            if (nameElement && currentUser.first_name) {
                                nameElement.textContent = `${currentUser.first_name} ${currentUser.last_name || ''}`;
                            }
                        }
                    } catch (profileError) {
                        // Don't alert or disrupt the UI flow for profile errors
                        console.warn('Error fetching user profile, continuing anyway:', profileError);
                    }
                }
            } catch (error) {
                console.error('Error in initMessaging:', error);
                // Don't show alert as it's disruptive - just show the issue in the contacts list
                contactList.innerHTML = `
                    <li class="contact-item text-center">
                        <div class="p-3">
                            <i class="fas fa-exclamation-circle text-warning"></i>
                            Error loading contacts. 
                            <a href="javascript:void(0)" onclick="location.reload()">Reload</a>
                        </div>
                    </li>
                `;
            }
        }
        
        // Load contacts (doctors and nurses the patient can message)
        async function loadContacts() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    contactList.innerHTML = `
                        <li class="contact-item text-center">
                            <div class="p-3">Please log in to view your contacts</div>
                        </li>
                    `;
                    return;
                }
                
                // Remove loading indicator to prevent duplicates if function called again
                const loadingElement = document.getElementById('loading-contacts');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                // Show loading indicator
                contactList.innerHTML = `
                    <li class="contact-item" id="loading-contacts">
                        <div style="text-align: center; width: 100%; padding: 15px 0;">
                            <div class="spinner-border text-primary" role="status" style="width: 1.5rem; height: 1.5rem;">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <div style="margin-top: 10px;">Loading contacts...</div>
                        </div>
                    </li>
                `;
                
                // Make API request to get contacts with a timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
                
                const response = await fetch(`${API_URL}/messages/contacts`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Failed to load contacts: ${response.status}`);
                }
                
                const data = await response.json();
                contacts = data.contacts || [];
                
                // Display contacts
                renderContacts(contacts);
                
            } catch (error) {
                console.error('Error loading contacts:', error);
                
                // Check if this is an abort error (timeout)
                if (error.name === 'AbortError') {
                    console.warn('Request timed out, loading sample data instead');
                }
                
                // Don't throw - fallback to sample data instead
                loadSampleData();
            }
        }
        
        // Load sample data for development/testing
        function loadSampleData() {
            // Sample contacts data - only doctors the patient has appointments with
            contacts = [
                { id: 1, name: 'Dr. Sarah Johnson', role: 'Cardiologist', unread_count: 3 },
                { id: 2, name: 'Dr. James Wilson', role: 'Neurologist', unread_count: 0 },
                { id: 3, name: 'Dr. Emily Chen', role: 'Dermatologist', unread_count: 1 },
                { id: 4, name: 'Nurse Roberts', role: 'Head Nurse', unread_count: 0 }
            ];
            
            // Remove loading indicator
            const loadingElement = document.getElementById('loading-contacts');
            if (loadingElement) {
                loadingElement.remove();
            }
            
            // Display contacts
            renderContacts(contacts);
        }
        
        // Render contacts in sidebar
        function renderContacts(contactsArray) {
            if (contactsArray.length === 0) {
                contactList.innerHTML = `
                    <li class="contact-item text-center">
                        <div class="p-3">No contacts available</div>
                    </li>
                `;
                return;
            }
            
            contactList.innerHTML = '';
            contactsArray.forEach(contact => {
                const initials = getInitials(contact.name);
                const unreadCount = contact.unread_count || 0;
                
                const contactItem = document.createElement('li');
                contactItem.className = 'contact-item';
                contactItem.dataset.id = contact.id;
                contactItem.dataset.role = contact.role;
                contactItem.innerHTML = `
                    <div class="contact-avatar">${initials}</div>
                    <div>
                        <div>${contact.name}</div>
                        <div class="contact-role">${contact.role}</div>
                    </div>
                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                `;
                
                contactItem.addEventListener('click', () => selectContact(contact));
                contactList.appendChild(contactItem);
            });
        }
        
        // Select a contact to chat with
        function selectContact(contact) {
            currentRecipient = contact;
            
            // Update UI
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`.contact-item[data-id="${contact.id}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
                // Remove unread badge
                const unreadBadge = selectedItem.querySelector('.unread-badge');
                if (unreadBadge) {
                    unreadBadge.remove();
                }
            }
            
            // Update chat header
            recipientName.textContent = contact.name;
            recipientRole.textContent = contact.role;
            recipientAvatar.textContent = getInitials(contact.name);
            
            // Show chat view
            emptyChatView.style.display = 'none';
            chatView.style.display = 'flex';
            
            // Load messages
            loadMessages(contact.id);
        }
        
        // Load messages for the selected contact
        async function loadMessages(contactId) {
            try {
                chatBody.innerHTML = `
                    <div class="message-loader">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <div class="mt-2">Loading messages...</div>
                    </div>
                `;
                
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Not authenticated');
                }
                
                // Make API request to get messages
                const response = await fetch(`${API_URL}/messages/${contactId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load messages');
                }
                
                const data = await response.json();
                messages = data.messages || [];
                
                // Display messages
                renderMessages(messages);
                
                // Mark messages as read
                markMessagesAsRead(contactId);
                
            } catch (error) {
                console.error('Error loading messages:', error);
                
                // For development - load sample messages if API fails
                loadSampleMessages(contactId);
            }
        }
        
        // Load sample messages for testing/development
        function loadSampleMessages(contactId) {
            // Sample messages based on contact
            if (contactId === 1) {
                messages = [
                    { id: 1, content: "Hello, Dr. Johnson. I've been experiencing chest pain after exercising.", is_sent: true, timestamp: "2023-05-10T10:30:00" },
                    { id: 2, content: "Hi Ahmed, could you describe the pain? Is it sharp or dull?", is_sent: false, timestamp: "2023-05-10T10:35:00" },
                    { id: 3, content: "It's a sharp pain, right in the center of my chest.", is_sent: true, timestamp: "2023-05-10T10:38:00" },
                    { id: 4, content: "How long does it last? Does it radiate to your arm or jaw?", is_sent: false, timestamp: "2023-05-10T10:40:00" },
                    { id: 5, content: "It lasts about 10 minutes and sometimes radiates to my left arm.", is_sent: true, timestamp: "2023-05-10T10:45:00" },
                    { id: 6, content: "I think we should schedule you for an in-person assessment. This could be angina. Please book an appointment as soon as possible.", is_sent: false, timestamp: "2023-05-10T10:50:00" }
                ];
            } else if (contactId === 2) {
                messages = [
                    { id: 1, content: "Dr. Wilson, I've been having frequent headaches since our last appointment.", is_sent: true, timestamp: "2023-05-05T14:20:00" },
                    { id: 2, content: "Are you taking the medication I prescribed?", is_sent: false, timestamp: "2023-05-05T15:30:00" },
                    { id: 3, content: "Yes, every day as directed.", is_sent: true, timestamp: "2023-05-05T15:45:00" },
                    { id: 4, content: "Let's schedule a follow-up to adjust your dosage.", is_sent: false, timestamp: "2023-05-05T16:00:00" }
                ];
            } else if (contactId === 3) {
                messages = [
                    { id: 1, content: "Dr. Chen, the rash has improved with the cream you prescribed.", is_sent: true, timestamp: "2023-05-08T09:10:00" },
                    { id: 2, content: "That's great news! Continue using it for another week as directed.", is_sent: false, timestamp: "2023-05-08T10:25:00" }
                ];
            } else if (contactId === 4) {
                messages = [
                    { id: 1, content: "Nurse Roberts, when should I come in for my next blood test?", is_sent: true, timestamp: "2023-05-09T11:00:00" },
                    { id: 2, content: "You're due for another test next Monday. You can come anytime between 8 AM and 4 PM.", is_sent: false, timestamp: "2023-05-09T11:30:00" },
                    { id: 3, content: "Do I need to fast before the test?", is_sent: true, timestamp: "2023-05-09T11:35:00" },
                    { id: 4, content: "Yes, please fast for 8 hours before the test. You can drink water.", is_sent: false, timestamp: "2023-05-09T11:40:00" },
                    { id: 5, content: "Thank you, I'll schedule for Monday morning.", is_sent: true, timestamp: "2023-05-09T11:45:00" }
                ];
            } else {
                messages = [];
            }
            
            // Display messages
            renderMessages(messages);
        }
        
        // Render messages in chat body
        function renderMessages(messagesArray) {
            chatBody.innerHTML = '';
            
            if (messagesArray.length === 0) {
                chatBody.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d;">
                        <i class="fas fa-comments" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <div>No messages yet</div>
                        <div style="font-size: 14px;">Start the conversation!</div>
                    </div>
                `;
                return;
            }
            
            messagesArray.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${msg.is_sent ? 'sent' : 'received'}`;
                messageElement.textContent = msg.content;
                
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = formatMessageTime(msg.timestamp);
                messageElement.appendChild(timeElement);
                
                chatBody.appendChild(messageElement);
            });
            
            // Scroll to bottom
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        // Send a message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentRecipient) return;
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    throw new Error('Not authenticated');
                }
                
                // Add message to UI immediately (optimistic update)
                const tempMessageElement = document.createElement('div');
                tempMessageElement.className = 'message sent';
                tempMessageElement.textContent = message;
                
                const tempTimeElement = document.createElement('div');
                tempTimeElement.className = 'message-time';
                tempTimeElement.textContent = 'Sending...';
                tempMessageElement.appendChild(tempTimeElement);
                
                chatBody.appendChild(tempMessageElement);
                chatBody.scrollTop = chatBody.scrollHeight;
                
                // Clear input
                messageInput.value = '';
                
                // Make API request to send message
                const response = await fetch(`${API_URL}/messages/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipient_id: currentRecipient.id,
                        content: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send message');
                }
                
                const data = await response.json();
                
                // Update the temporary message with the actual message data
                tempTimeElement.textContent = 'Just now';
                
                // Reload messages to ensure we have the latest
                await loadMessages(currentRecipient.id);
                
            } catch (error) {
                console.error('Error sending message:', error);
                
                // For development - simulate successful send
                // In a real app, you'd show an error message instead
                const now = new Date();
                messages.push({
                    id: messages.length + 1,
                    content: message,
                    is_sent: true,
                    timestamp: now.toISOString()
                });
                
                // Auto-response for demo (simulate doctor response)
                setTimeout(() => {
                    const autoResponse = {
                        id: messages.length + 1,
                        content: getAutoResponse(currentRecipient.id),
                        is_sent: false,
                        timestamp: new Date().toISOString()
                    };
                    messages.push(autoResponse);
                    renderMessages(messages);
                }, 1500);
                
                renderMessages(messages);
            }
        }
        
        // Simple auto-response based on doctor (for demo/development)
        function getAutoResponse(doctorId) {
            const responses = [
                "I'll review this information. Thank you.",
                "Thanks for the update. I'll note this in your chart.",
                "Let me know if your symptoms change.",
                "This is helpful information. Let's discuss this further at your next appointment.",
                "I've received your message and will follow up soon."
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        // Mark messages as read
        async function markMessagesAsRead(contactId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                // Make API request to mark messages as read
                await fetch(`${API_URL}/messages/mark-read/${contactId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }
        
        // Filter contacts by search term
        function filterContacts(searchTerm) {
            const filtered = contacts.filter(contact => {
                return contact.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                       contact.role.toLowerCase().includes(searchTerm.toLowerCase());
            });
            renderContacts(filtered);
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Send message on button click
            sendButton.addEventListener('click', sendMessage);
            
            // Send message on Enter key (but allow Shift+Enter for new line)
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Filter contacts on search input
            contactSearchInput.addEventListener('input', (e) => {
                filterContacts(e.target.value);
            });
            
            // Refresh chat on button click
            refreshChatButton.addEventListener('click', () => {
                if (currentRecipient) {
                    loadMessages(currentRecipient.id);
                }
            });
            
            // Auto-resize textarea
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
            });
        }
        
        // Helper function to get initials from a name
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }
        
        // Helper function to format message time
        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const yesterday = new Date(now);
            yesterday.setDate(now.getDate() - 1);
            
            // Same day
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            // Yesterday
            else if (date.toDateString() === yesterday.toDateString()) {
                return `Yesterday, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            }
            // This week
            else if (now.getTime() - date.getTime() < 7 * 24 * 60 * 60 * 1000) {
                return `${date.toLocaleDateString([], { weekday: 'short' })}, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            }
            // Older
            else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }
        
        // Helper function to show error message
        function showError(message) {
            // Replace alert with a non-blocking toast or in-page notification
            console.error(message);
            
            // Add a notification to the page instead of an alert
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background-color: #f8d7da;
                color: #721c24;
                padding: 10px 20px;
                border-radius: 4px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                z-index: 1000;
                max-width: 300px;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span>${message}</span>
                    <button style="background: none; border: none; cursor: pointer; margin-left: 10px; font-weight: bold;">&times;</button>
                </div>
            `;
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
            
            // Remove on click
            notification.querySelector('button').addEventListener('click', () => {
                notification.remove();
            });
        }
        
        // Helper function to get current user profile (safe version that won't redirect)
        async function getCurrentUserProfile() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return null;
                
                // First check if we already have user data in localStorage
                const userData = JSON.parse(localStorage.getItem('user') || '{}');
                if (userData && userData.id) {
                    return userData;
                }
                
                // If not, try to fetch it from the API
                const response = await fetch(`${API_URL}/user/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    // Don't automatically clear tokens on error
                    console.warn('Error fetching profile:', response.status);
                    return null;
                }
                
                const data = await response.json();
                
                // Save user data to localStorage
                localStorage.setItem('user', JSON.stringify(data.user));
                
                return data.user;
            } catch (error) {
                console.error('Error getting user profile:', error);
                return null;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initMessaging);
    </script>
</body>
</html>
