<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Dashboard â€“ Mediplus</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="../js/doctor-calendar.js"></script>
  <style>
    /* ====== Baseline styles ====== */
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
    body{display:flex;min-height:100vh;background:#f8f9fa}
    /* ====== Sidebar ====== */
    .sidebar{width:280px;background:linear-gradient(180deg,#0066cc 0%,#0052a3 100%);padding:30px;color:#fff;box-shadow:4px 0 10px rgba(0,0,0,.1);display:flex;flex-direction:column}
    .sidebar a{display:flex;align-items:center;color:rgba(255,255,255,.85);text-decoration:none;padding:12px 15px;margin-bottom:10px;border-radius:8px;transition:.3s}
    .sidebar a i{margin-right:12px;font-size:18px}
    .sidebar a:hover,.sidebar a.active{background:rgba(255,255,255,.15);color:#fff;transform:translateX(5px)}
    .logout-btn{margin-top:auto!important;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25)}
    .logout-btn:hover{background:rgba(255,0,0,.1)!important;border-color:rgba(255,0,0,.25)}
    /* ====== Main area ====== */
    .main-content{flex:1;padding:30px;overflow-y:auto}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:#fff;padding:20px;border-radius:12px;display:flex;gap:15px;align-items:center;box-shadow:0 4px 12px rgba(0,0,0,.05)}
    .stat-icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
    .stat-info h3{font-size:24px;color:#333;margin-bottom:4px}
    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:25px}
    .card{background:#fff;padding:25px;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .card-title{font-size:18px;font-weight:600;color:#333}
    #calendar{height:450px;}
    /* ====== Responsive ====== */
    @media(max-width:768px){.sidebar{width:80px;padding:20px 10px}.sidebar span{display:none}.main-content{padding:20px}}
  </style>
</head>
<body>
  <!-- ===== Sidebar ===== -->
  <aside class="sidebar">
        
    <a href="doctor-dashboard.html" class="nav-link"><i class="fas fa-home"></i><span>Dashboard</span></a>
    <a href="doctor-appointments.html" class="nav-link"><i class="fas fa-calendar-alt"></i><span>Appointments</span></a>
    <a href="doctor-patients.html" class="nav-link"><i class="fas fa-user-injured"></i><span>Patients</span></a>
    <a href="doctor-prescriptions.html" class="nav-link"><i class="fas fa-prescription"></i><span>Edit Availabilities</span></a>
    <a href="doctor-records.html" class="nav-link"><i class="fas fa-file-medical"></i><span>Medical Records</span></a>
    <a href="doctor-messages.html" class="nav-link"><i class="fas fa-comments"></i><span>Messages</span></a>
    <a href="../index.html" class="nav-link logout-btn"><i class="fas fa-door-open"></i><span>back</span></a>
</aside>

  <!-- ===== Main ===== -->
  <main class="main-content">
    <!-- KPI tiles -->
    <section class="stats-grid">
      <div class="stat-card"><div class="stat-icon" style="background:#e3f2fd;color:#0066cc"><i class="fas fa-calendar-check"></i></div><div class="stat-info"><h3 id="todayAppointmentsCount">8</h3><p>Today's Appointments</p></div></div>
      <div class="stat-card"><div class="stat-icon" style="background:#e8f5e9;color:#2e7d32"><i class="fas fa-user-injured"></i></div><div class="stat-info"><h3 id="activePatientCount">24</h3><p>Active Patients</p></div></div>
      <div class="stat-card"><div class="stat-icon" style="background:#fff3e0;color:#ef6c00"><i class="fas fa-prescription-bottle"></i></div><div class="stat-info"><h3 id="pendingPrescriptionsCount">12</h3><p>Pending Prescriptions</p></div></div>
      <div class="stat-card"><div class="stat-icon" style="background:#fce4ec;color:#c2185b"><i class="fas fa-heartbeat"></i></div><div class="stat-info"><h3 id="satisfactionRate">95%</h3><p>Patient Satisfaction</p></div></div>
    </section>

    <!-- Calendar + Upcoming -->
    <section class="dashboard-grid">
      <div class="card" style="grid-column:span 2;">
        <div class="card-header"><h2 class="card-title">Appointment Calendar</h2><button style="padding:8px 16px;background:#0066cc;color:#fff;border:none;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:8px" onclick="addAppointment()"><i class="fas fa-plus"></i>New</button></div>
        <div id="calendar"></div>
      </div>
      <div class="card">
        <h2 class="card-title" style="margin-bottom:15px">Upcoming Patients</h2>
        <div id="upcomingPatientsList" style="display:flex;flex-direction:column;gap:12px">
          <div class="loading-indicator" style="text-align:center;padding:20px;">
            <i class="fas fa-spinner fa-spin" style="color:#0066cc;font-size:20px;margin-bottom:10px;"></i>
            <p style="color:#666;margin:0;">Loading upcoming appointments...</p>
          </div>
        </div>
      </div>
    </section>
    
    <div id="errorContainer" style="position:fixed;bottom:20px;right:20px;z-index:1000;"></div>
  </main>

  <script>
    let dashboardCalendar;
    let upcomingAppointments = [];
    
    document.addEventListener('DOMContentLoaded', function() {
      initializeDashboard();
    });
    
    async function initializeDashboard() {
      try {
        dashboardCalendar = initDoctorCalendar('calendar', {
          initialView: 'timeGridDay',
          height: 500,
          headerToolbar: {start: 'title', center: '', end: 'today prev,next'},
          nowIndicator: true,
          dayMaxEvents: true,
          eventContent: function(arg) {
            const isBooked = arg.event.extendedProps.isBooked;
            if (!isBooked) return;
            
            return {
              html: `
                <div style="font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                  <div><strong>${arg.timeText}</strong> - ${arg.event.title}</div>
                  <div style="opacity:0.8;font-size:11px;">${arg.event.extendedProps.type || 'Consultation'}</div>
                </div>
              `
            };
          }
        });
        
        updateDashboardStats();
        setInterval(updateDashboardStats, 60000);
      } catch (error) {
        console.error('Error initializing dashboard:', error);
        showMessage('Failed to initialize dashboard: ' + error.message, 'error');
      }
    }
    
    async function updateDashboardStats() {
      try {
        const token = getAuthToken();
        if (!token) {
          showMessage('Authentication required. Please log in again.', 'warning');
          return;
        }
        
        const doctorId = getCurrentDoctorId();
        
        updateUpcomingPatientsFromCalendar();
        
        try {
          const response = await fetch(`http://localhost:5000/doctors/${doctorId}/stats`, {
            method: 'GET',
            headers: {
              'Accept': 'application/json',
              'Authorization': `Bearer ${token}`
            }
          });
          
          if (response.ok) {
            const statsData = await response.json();
            document.getElementById('todayAppointmentsCount').textContent = statsData.today_appointments || '0';
            document.getElementById('activePatientCount').textContent = statsData.active_patients || '0';
            document.getElementById('pendingPrescriptionsCount').textContent = statsData.pending_prescriptions || '0';
            document.getElementById('satisfactionRate').textContent = statsData.satisfaction_rate || 'N/A';
          } else {
            console.warn('Could not fetch doctor stats, using dummy data');
          }
        } catch (error) {
          console.warn('Error fetching doctor stats:', error);
          document.getElementById('todayAppointmentsCount').textContent = '8';
          document.getElementById('activePatientCount').textContent = '24';
          document.getElementById('pendingPrescriptionsCount').textContent = '12';
          document.getElementById('satisfactionRate').textContent = '95%';
        }
      } catch (error) {
        console.error('Error updating dashboard stats:', error);
      }
    }
    
    function updateUpcomingPatientsFromCalendar() {
      const upcomingList = document.getElementById('upcomingPatientsList');
      if (!upcomingList) return;
      
      upcomingList.innerHTML = '';
      
      let events = [];
      if (window.doctorCalendar) {
        events = window.doctorCalendar.getEvents();
      } else if (dashboardCalendar) {
        events = dashboardCalendar.getEvents();
      }
      
      const now = new Date();
      const bookedEvents = events.filter(event => 
        event.extendedProps && event.extendedProps.isBooked && event.start >= now
      ).sort((a, b) => a.start - b.start);
      
      const upcomingEvents = bookedEvents.slice(0, 3);
      
      if (upcomingEvents.length === 0) {
        upcomingList.innerHTML = `
          <div style="text-align:center;padding:20px;color:#666;">
            <i class="far fa-calendar-times" style="font-size:24px;margin-bottom:10px;display:block;"></i>
            <p>No upcoming appointments</p>
          </div>
        `;
        return;
      }
      
      upcomingEvents.forEach(event => {
        const patientName = event.extendedProps.patientName || event.title;
        const appointmentType = event.extendedProps.type || 'Consultation';
        const time = event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        const appointmentItem = document.createElement('div');
        appointmentItem.style.cssText = 'background:#f8f9fa;padding:15px;border-radius:10px;display:flex;justify-content:space-between;align-items:center';
        appointmentItem.innerHTML = `
          <div>
            <div style="font-weight:600;color:#333">${patientName}</div>
            <small style="color:#666">${time} â€“ ${appointmentType}</small>
          </div>
          <button onclick="viewPatientDetails('${patientName}')" style="padding:6px 12px;border:1px solid #0066cc;background:#fff;color:#0066cc;border-radius:6px;cursor:pointer">View</button>
        `;
        
        upcomingList.appendChild(appointmentItem);
      });
    }
    
    function viewPatientDetails(patientName) {
      showMessage(`Viewing patient details for: ${patientName}`, 'info');
    }
    
    function addAppointment() {
      window.location.href = 'doctor-appointments.html';
    }
    
    function showMessage(message, type = 'info') {
      const errorContainer = document.getElementById('errorContainer');
      if (!errorContainer) return;
      
      const messageEl = document.createElement('div');
      messageEl.className = `alert-${type}`;
      messageEl.style.cssText = 'padding:10px 15px;border-radius:4px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);';
      
      switch(type) {
        case 'success':
          messageEl.style.background = '#e8f5e9';
          messageEl.style.color = '#2e7d32';
          break;
        case 'info':
          messageEl.style.background = '#e3f2fd';
          messageEl.style.color = '#0d47a1';
          break;
        case 'warning':
          messageEl.style.background = '#fff3e0';
          messageEl.style.color = '#ef6c00';
          break;
        case 'error':
          messageEl.style.background = '#ffebee';
          messageEl.style.color = '#c62828';
          break;
      }
      
      messageEl.textContent = message;
      errorContainer.appendChild(messageEl);
      
      if (type !== 'error') {
        setTimeout(() => {
          messageEl.remove();
        }, 3000);
      }
    }
  </script>
</body>
</html>
