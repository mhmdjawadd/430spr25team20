<!DOCTYPE html>
<html class="no-js" lang="en">
    <head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="keywords" content="Site keywords here">
		<meta name="description" content="">
		<meta name='copyright' content=''>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		
		<!-- Title -->
        <title>Messages - Nabad Health System</title>
		
		<!-- Favicon -->
        <link rel="icon" href="img/favicon.png">
		
		<!-- Google Fonts -->
		<link href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
		<!-- Bootstrap CSS -->
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<!-- Font Awesome CSS -->
        <link rel="stylesheet" href="css/font-awesome.min.css">
		<!-- icofont CSS -->
        <link rel="stylesheet" href="css/icofont.css">
		<!-- Slicknav -->
		<link rel="stylesheet" href="css/slicknav.min.css">
		<!-- Owl Carousel CSS -->
        <link rel="stylesheet" href="css/owl-carousel.css">
		<!-- Datepicker CSS -->
		<link rel="stylesheet" href="css/datepicker.css">
		<!-- Animate CSS -->
        <link rel="stylesheet" href="css/animate.min.css">
		<!-- Magnific Popup CSS -->
        <link rel="stylesheet" href="css/magnific-popup.css">
		
		<!-- Medipro CSS -->
        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="style.css">
        <link rel="stylesheet" href="css/responsive.css">
		
		<style>
			.messaging-container {
				display: flex;
				min-height: 70vh;
				margin: 30px 0;
				border-radius: 8px;
				overflow: hidden;
				box-shadow: 0 0 20px rgba(0,0,0,0.1);
			}
			.contacts-sidebar {
				width: 300px;
				background: #f8f9fa;
				border-right: 1px solid #e9ecef;
				overflow-y: auto;
			}
			.contacts-header {
				padding: 15px;
				background: #1A76D1;
				color: white;
				font-weight: 600;
			}
			.contact-search {
				padding: 10px;
				background: #f1f3f5;
			}
			.contact-search input {
				width: 100%;
				padding: 8px 12px;
				border: 1px solid #ddd;
				border-radius: 4px;
			}
			.contact-list {
				list-style: none;
				padding: 0;
				margin: 0;
			}
			.contact-item {
				padding: 15px;
				border-bottom: 1px solid #e9ecef;
				cursor: pointer;
				position: relative;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
			}
			.contact-item:hover {
				background: #e9ecef;
			}
			.contact-item.active {
				background: #e2f0fd;
				border-left: 3px solid #1A76D1;
			}
			.contact-avatar {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				margin-right: 15px;
				background: #1A76D1;
				color: white;
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: 600;
			}
			.contact-role {
				font-size: 12px;
				color: #6c757d;
				margin-top: 2px;
			}
			.unread-badge {
				position: absolute;
				right: 15px;
				top: 50%;
				transform: translateY(-50%);
				background: #1A76D1;
				color: white;
				border-radius: 50%;
				width: 20px;
				height: 20px;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 12px;
				font-weight: 600;
			}
			.chat-area {
				flex: 1;
				display: flex;
				flex-direction: column;
				background: white;
			}
			.chat-header {
				padding: 15px 20px;
				background: white;
				border-bottom: 1px solid #e9ecef;
				display: flex;
				align-items: center;
				justify-content: space-between;
			}
			.chat-recipient-info {
				display: flex;
				align-items: center;
			}
			.recipient-avatar {
				width: 40px;
				height: 40px;
				border-radius: 50%;
				margin-right: 15px;
				background: #1A76D1;
				color: white;
				display: flex;
				align-items: center;
				justify-content: center;
				font-weight: 600;
			}
			.recipient-details h4 {
				margin: 0;
				font-size: 16px;
				font-weight: 600;
			}
			.recipient-details .role {
				font-size: 12px;
				color: #6c757d;
			}
			.chat-actions .btn {
				font-size: 14px;
				padding: 5px 10px;
			}
			.chat-body {
				flex: 1;
				padding: 20px;
				overflow-y: auto;
				background: #f8f9fa;
				display: flex;
				flex-direction: column;
			}
			.message {
				max-width: 75%;
				padding: 10px 15px;
				border-radius: 10px;
				margin-bottom: 15px;
				position: relative;
				word-break: break-word;
			}
			.message.sent {
				background: #cce5ff;
				border-bottom-right-radius: 0;
				align-self: flex-end;
			}
			.message.received {
				background: #f1f3f5;
				border-bottom-left-radius: 0;
				align-self: flex-start;
			}
			.message-time {
				font-size: 11px;
				color: #6c757d;
				position: absolute;
				bottom: -18px;
				white-space: nowrap;
			}
			.message.sent .message-time {
				right: 5px;
			}
			.message.received .message-time {
				left: 5px;
			}
			.chat-footer {
				padding: 15px;
				background: white;
				border-top: 1px solid #e9ecef;
				display: flex;
				align-items: center;
			}
			.chat-footer textarea {
				flex: 1;
				padding: 10px 15px;
				border: 1px solid #e9ecef;
				border-radius: 20px;
				resize: none;
				height: 40px;
				line-height: 20px;
				max-height: 100px;
			}
			.chat-footer button {
				margin-left: 10px;
				border: none;
				background: #1A76D1;
				color: white;
				border-radius: 50%;
				width: 40px;
				height: 40px;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				transition: all 0.3s ease;
			}
			.chat-footer button:hover {
				background: #0056b3;
			}
			.empty-chat {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				height: 100%;
				color: #6c757d;
			}
			.empty-chat i {
				font-size: 60px;
				margin-bottom: 20px;
				color: #e9ecef;
			}
			.empty-chat-message {
				font-size: 16px;
				margin-bottom: 10px;
			}
			.empty-chat-subtext {
				font-size: 14px;
				text-align: center;
				max-width: 300px;
			}
			.message-loader {
				text-align: center;
				padding: 20px 0;
				color: #6c757d;
			}
			
			.logout-btn{
				color: #1a1a1a;
				font-size: 16px;
				font-weight: 500;
				transition: color 0.3s;
				margin-top: 20px;
			}

			.logout-btn:hover {
				color: #0066cc;
				text-decoration: underline;
			}
			
			/* Nav menu user greeting (same as index) */
			.nav.menu .user-greeting {
				display: inline-flex;
				align-items: center;
				margin-left: auto;
				color: #1A76D1;
			}
			.nav.menu .user-greeting i {
				margin-right: 5px;
			}
			.navigation .nav.menu {
				display: flex;
				align-items: center;
			}
		</style>
    </head>
    <body>
		<!-- Preloader -->
        <div class="preloader">
            <div class="loader">
                <div class="loader-outter"></div>
                <div class="loader-inner"></div>
                <div class="indicator"> 
                    <svg width="16px" height="12px">
                        <polyline id="back" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
                        <polyline id="front" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
                    </svg>
                </div>
            </div>
        </div>
        
		<!-- Header Area -->
		<header class="header">
			
			<div class="header-inner">
				<div class="container">
					<div class="inner">
						<div class="row">
							<div class="col-lg-3 col-md-3 col-12">
								
								<div class="logo">
									<a href="index.html"><img src="img/nabad.png" alt="#"></a>
								</div>
								
								<div class="mobile-nav"></div>
								
							</div>
							<div class="col-lg-9 col-md-9 col-12">
								
								<div class="main-menu">
									<nav class="navigation">
										<ul class="nav menu">
											<li><a href="index.html">Home</a></li>
											<li><a href="doctors.html">Doctors</a></li>
											<li><a href="services.html">Services</a></li>
											<li><a href="appointments.html">Book Appointment</a></li>
											<li><a href="contact.html">Contact Us</a></li>
											<li class="reminder-icon">
												<a href="reminder-preferences.html">
													<i class="fa fa-bell"></i>
													<span class="reminder-tooltip"></span>
												</a>
											</li>
											
											<li><a href="login.html" class="logout-btn" onclick="handleLogout()">
												<i class="fas fa-door-open"></i>
											</a></li>
											<li class="user-greeting"><span id="userGreeting"></span></li>
										</ul>
									</nav>
								</div>
							
							</div>
						</div>
					</div>
				</div>
			</div>
			
		</header>
		<!-- End Header Area -->
		
		<!-- Breadcrumbs -->
		<div class="breadcrumbs overlay">
			<div class="container">
				<div class="bread-inner">
					<div class="row">
						<div class="col-12">
							<h2>Messages</h2>
							<ul class="bread-list">
								<li><a href="index.html">Home</a></li>
								<li><i class="icofont-simple-right"></i></li>
								<li class="active">Messages</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- End Breadcrumbs -->

		<section class="messaging-section section">
			<div class="container">
				<div class="row">
					<div class="col-12">
						<div class="section-title">
							<h2>Healthcare Messaging</h2>
							<img src="img/section-img.png" alt="#">
							<p>Connect with your healthcare providers securely</p>
						</div>
					</div>
				</div>
				
				<div class="messaging-container">
					<!-- Contacts Sidebar -->
					<div class="contacts-sidebar">
						<div class="contacts-header">
							Messages
						</div>
						<div class="contact-search">
							<input type="text" placeholder="Search contacts..." id="contactSearchInput">
						</div>
						<ul class="contact-list" id="contactList">
							<!-- Will be populated by JavaScript -->
							<li class="contact-item" id="loading-contacts">
								<div class="text-center w-100 py-3">
									<div class="spinner-border text-primary" role="status">
										<span class="sr-only">Loading...</span>
									</div>
									<div class="mt-2">Loading contacts...</div>
								</div>
							</li>
						</ul>
					</div>
					
					<!-- Chat Area -->
					<div class="chat-area">
						<div id="emptyChatView" class="empty-chat">
							<i class="fas fa-comments"></i>
							<div class="empty-chat-message">Select a contact to start messaging</div>
							<div class="empty-chat-subtext">You can message your doctors and nurses about non-urgent matters</div>
						</div>
						
						<div id="chatView" class="d-none" style="display: flex; flex-direction: column; height: 100%;">
							<div class="chat-header">
								<div class="chat-recipient-info">
									<div class="recipient-avatar" id="recipientAvatar">JD</div>
									<div class="recipient-details">
										<h4 id="recipientName">John Doe</h4>
										<div class="role" id="recipientRole">Doctor</div>
									</div>
								</div>
								<div class="chat-actions">
									<button class="btn btn-sm btn-outline-primary" id="refreshChat">
										<i class="fas fa-sync-alt"></i> Refresh
									</button>
								</div>
							</div>
							<div class="chat-body" id="chatBody">
								<!-- Will be populated by JavaScript -->
								<div class="message-loader">
									<div class="spinner-border spinner-border-sm text-primary" role="status">
										<span class="sr-only">Loading...</span>
									</div>
									<div class="mt-2">Loading messages...</div>
								</div>
							</div>
							<div class="chat-footer">
								<textarea id="messageInput" placeholder="Type a message..."></textarea>
								<button id="sendButton">
									<i class="fas fa-paper-plane"></i>
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>
		
		<!-- Footer Area -->
		<footer id="footer" class="footer ">
			
			<div class="footer-top">
				<div class="container">
					<div class="row">
						<div class="col-lg-3 col-md-6 col-12">
							<div class="single-footer">
								<h2>About Us</h2>
								<p>We are a leading healthcare provider committed to delivering exceptional medical services with compassion and expertise. Our state-of-the-art facilities and experienced team ensure the highest quality patient care.</p>
								
								<ul class="social">
									<li><a href="#"><i class="icofont-facebook"></i></a></li>
									<li><a href="#"><i class="icofont-google-plus"></i></a></li>
									<li><a href="#"><i class="icofont-twitter"></i></a></li>
									<li><a href="#"><i class="icofont-vimeo"></i></a></li>
									<li><a href="#"><i class="icofont-pinterest"></i></a></li>
								</ul>
								
							</div>
						</div>
						<div class="col-lg-3 col-md-6 col-12">
							<div class="single-footer f-link">
								<h2>Quick Links</h2>
								<div class="row">
									<div class="col-lg-6 col-md-6 col-12">
										<ul>
											<li><a href="index.html"><i class="fa fa-caret-right" aria-hidden="true"></i>Home</a></li>
											<li><a href="doctors.html"><i class="fa fa-caret-right" aria-hidden="true"></i>Doctors</a></li>
											<li><a href="services.html"><i class="fa fa-caret-right" aria-hidden="true"></i>Services</a></li>
											<li><a href="contact.html"><i class="fa fa-caret-right" aria-hidden="true"></i>Contact Us</a></li>	
										</ul>
									</div>
								</div>
							</div>
						</div>
						<div class="col-lg-3 col-md-6 col-12">
							<div class="single-footer">
								<h2>Open Hours</h2>
								<ul class="time-sidual">
									<li class="day">Monday - Friday <span>8.00-20.00</span></li>
									<li class="day">Saturday <span>9.00-18.30</span></li>
									<li class="day">Sunday <span>9.00-15.00</span></li>
								</ul>
							</div>
						</div>
						<div class="col-lg-3 col-md-6 col-12">
							<div class="single-footer">
								<h2>Newsletter</h2>
								<p>Subscribe to our newsletter to get all our news in your inbox.</p>
								<form action="mail/mail.php" method="get" target="_blank" class="newsletter-inner">
									<input name="email" placeholder="Email Address" class="common-input" type="email">
									<button class="button"><i class="icofont icofont-paper-plane"></i></button>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="copyright">
				<div class="container">
					<div class="row">
						<div class="col-lg-12 col-md-12 col-12">
							<div class="copyright-content">
								<p>© Copyright 2024 | All Rights Reserved</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		
		</footer>
		<!-- End Footer Area -->

        <!-- JavaScript Libraries -->
        <script src="js/jquery.min.js"></script>
        <script src="js/jquery-migrate-3.0.0.js"></script>
        <script src="js/jquery-ui.min.js"></script>
        <script src="js/easing.js"></script>
        <script src="js/colors.js"></script>
        <script src="js/popper.min.js"></script>
        <script src="js/bootstrap-datepicker.js"></script>
        <script src="js/jquery.nav.js"></script>
        <script src="js/slicknav.min.js"></script>
        <script src="js/jquery.scrollUp.min.js"></script>
        <script src="js/niceselect.js"></script>
        <script src="js/tilt.jquery.min.js"></script>
        <script src="js/owl-carousel.js"></script>
        <script src="js/jquery.counterup.min.js"></script>
        <script src="js/steller.js"></script>
        <script src="js/wow.min.js"></script>
        <script src="js/jquery.magnific-popup.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/main.js"></script>
        <script src="js/auth-api.js"></script>
        
        <!-- Messaging JavaScript -->
        <script>
            // Global variables
            let currentUser = null;
            let currentRecipient = null;
            let contacts = [];
            let messages = [];
            const API_URL = 'http://localhost:5000';
            
            // DOM elements
            const contactList = document.getElementById('contactList');
            const emptyChatView = document.getElementById('emptyChatView');
            const chatView = document.getElementById('chatView');
            const chatBody = document.getElementById('chatBody');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const recipientName = document.getElementById('recipientName');
            const recipientRole = document.getElementById('recipientRole');
            const recipientAvatar = document.getElementById('recipientAvatar');
            const contactSearchInput = document.getElementById('contactSearchInput');
            const refreshChatButton = document.getElementById('refreshChat');
            
            // Init function that runs on page load
            async function initMessaging() {
                // Get current user
                try {
                    currentUser = await getCurrentUserProfile();
                    if (!currentUser) {
                        // Redirect to login if not logged in
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    // Set user greeting
                    const userGreeting = document.getElementById('userGreeting');
                    if (userGreeting) {
                        const name = currentUser?.first_name || currentUser?.email?.split('@')[0] || 'Guest';
                        userGreeting.innerHTML = `<i class="fas fa-user-circle"></i> Hi, ${name}!`;
                    }
                    
                    // Load contacts
                    await loadContacts();
                    
                    // Setup event listeners
                    setupEventListeners();
                    
                } catch (error) {
                    console.error('Error initializing messaging:', error);
                    showError('Failed to load messaging. Please try again later.');
                }
            }
            
            // Load contacts (doctors and nurses the patient can message)
            async function loadContacts() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        throw new Error('Not authenticated');
                    }
                    
                    // Make API request to get contacts
                    const response = await fetch(`${API_URL}/messages/contacts`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load contacts');
                    }
                    
                    const data = await response.json();
                    contacts = data.contacts || [];
                    
                    // Remove loading indicator
                    const loadingElement = document.getElementById('loading-contacts');
                    if (loadingElement) {
                        loadingElement.remove();
                    }
                    
                    // Display contacts
                    renderContacts(contacts);
                    
                } catch (error) {
                    console.error('Error loading contacts:', error);
                    contactList.innerHTML = `
                        <li class="contact-item text-center">
                            <div class="text-danger p-3">
                                <i class="fas fa-exclamation-triangle"></i> Failed to load contacts
                            </div>
                        </li>
                    `;
                }
            }
            
            // Render contacts in sidebar
            function renderContacts(contactsArray) {
                if (contactsArray.length === 0) {
                    contactList.innerHTML = `
                        <li class="contact-item text-center">
                            <div class="p-3">No contacts available</div>
                        </li>
                    `;
                    return;
                }
                
                contactList.innerHTML = '';
                contactsArray.forEach(contact => {
                    const initials = getInitials(contact.name);
                    const unreadCount = contact.unread_count || 0;
                    
                    const contactItem = document.createElement('li');
                    contactItem.className = 'contact-item';
                    contactItem.dataset.id = contact.id;
                    contactItem.dataset.role = contact.role;
                    contactItem.innerHTML = `
                        <div class="contact-avatar">${initials}</div>
                        <div>
                            <div>${contact.name}</div>
                            <div class="contact-role">${contact.role}</div>
                        </div>
                        ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                    `;
                    
                    contactItem.addEventListener('click', () => selectContact(contact));
                    contactList.appendChild(contactItem);
                });
            }
            
            // Select a contact to chat with
            function selectContact(contact) {
                currentRecipient = contact;
                
                // Update UI
                document.querySelectorAll('.contact-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const selectedItem = document.querySelector(`.contact-item[data-id="${contact.id}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('active');
                    // Remove unread badge
                    const unreadBadge = selectedItem.querySelector('.unread-badge');
                    if (unreadBadge) {
                        unreadBadge.remove();
                    }
                }
                
                // Update chat header
                recipientName.textContent = contact.name;
                recipientRole.textContent = contact.role;
                recipientAvatar.textContent = getInitials(contact.name);
                
                // Show chat view
                emptyChatView.style.display = 'none';
                chatView.classList.remove('d-none');
                chatView.style.display = 'flex';
                
                // Load messages
                loadMessages(contact.id);
            }
            
            // Load messages for the selected contact
            async function loadMessages(contactId) {
                try {
                    chatBody.innerHTML = `
                        <div class="message-loader">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <div class="mt-2">Loading messages...</div>
                        </div>
                    `;
                    
                    const token = localStorage.getItem('token');
                    if (!token) {
                        throw new Error('Not authenticated');
                    }
                    
                    // Make API request to get messages
                    const response = await fetch(`${API_URL}/messages/${contactId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to load messages');
                    }
                    
                    const data = await response.json();
                    messages = data.messages || [];
                    
                    // Display messages
                    renderMessages(messages);
                    
                    // Mark messages as read
                    markMessagesAsRead(contactId);
                    
                } catch (error) {
                    console.error('Error loading messages:', error);
                    chatBody.innerHTML = `
                        <div class="text-center text-danger p-3">
                            <i class="fas fa-exclamation-triangle"></i> Failed to load messages
                        </div>
                    `;
                }
            }
            
            // Render messages in chat body
            function renderMessages(messagesArray) {
                chatBody.innerHTML = '';
                
                if (messagesArray.length === 0) {
                    chatBody.innerHTML = `
                        <div class="text-center p-3 text-muted">
                            <i class="fas fa-comments"></i>
                            <div>No messages yet</div>
                            <div class="small">Start the conversation!</div>
                        </div>
                    `;
                    return;
                }
                
                messagesArray.forEach(msg => {
                    const messageElement = document.createElement('div');
                    messageElement.className = `message ${msg.is_sent ? 'sent' : 'received'}`;
                    messageElement.textContent = msg.content;
                    
                    const timeElement = document.createElement('div');
                    timeElement.className = 'message-time';
                    timeElement.textContent = formatMessageTime(msg.timestamp);
                    messageElement.appendChild(timeElement);
                    
                    chatBody.appendChild(messageElement);
                });
                
                // Scroll to bottom
                chatBody.scrollTop = chatBody.scrollHeight;
            }
            
            // Send a message
            async function sendMessage() {
                const message = messageInput.value.trim();
                if (!message || !currentRecipient) return;
                
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        throw new Error('Not authenticated');
                    }
                    
                    // Add message to UI immediately (optimistic update)
                    const tempMessageElement = document.createElement('div');
                    tempMessageElement.className = 'message sent';
                    tempMessageElement.textContent = message;
                    
                    const tempTimeElement = document.createElement('div');
                    tempTimeElement.className = 'message-time';
                    tempTimeElement.textContent = 'Sending...';
                    tempMessageElement.appendChild(tempTimeElement);
                    
                    chatBody.appendChild(tempMessageElement);
                    chatBody.scrollTop = chatBody.scrollHeight;
                    
                    // Clear input
                    messageInput.value = '';
                    
                    // Make API request to send message
                    const response = await fetch(`${API_URL}/messages/send`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            recipient_id: currentRecipient.id,
                            content: message
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to send message');
                    }
                    
                    const data = await response.json();
                    
                    // Update the temporary message with the actual message data
                    tempTimeElement.textContent = 'Just now';
                    
                    // Reload messages to ensure we have the latest
                    await loadMessages(currentRecipient.id);
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    alert('Failed to send message. Please try again.');
                }
            }
            
            // Mark messages as read
            async function markMessagesAsRead(contactId) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;
                    
                    // Make API request to mark messages as read
                    await fetch(`${API_URL}/messages/mark-read/${contactId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                } catch (error) {
                    console.error('Error marking messages as read:', error);
                }
            }
            
            // Filter contacts by search term
            function filterContacts(searchTerm) {
                const filtered = contacts.filter(contact => {
                    return contact.name.toLowerCase().includes(searchTerm.toLowerCase());
                });
                renderContacts(filtered);
            }
            
            // Setup event listeners
            function setupEventListeners() {
                // Send message on button click
                sendButton.addEventListener('click', sendMessage);
                
                // Send message on Enter key (but allow Shift+Enter for new line)
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Filter contacts on search input
                contactSearchInput.addEventListener('input', (e) => {
                    filterContacts(e.target.value);
                });
                
                // Refresh chat on button click
                refreshChatButton.addEventListener('click', () => {
                    if (currentRecipient) {
                        loadMessages(currentRecipient.id);
                    }
                });
                
                // Auto-resize textarea
                messageInput.addEventListener('input', () => {
                    messageInput.style.height = 'auto';
                    messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
                });
            }
            
            // Helper function to get initials from a name
            function getInitials(name) {
                if (!name) return '?';
                return name.split(' ').map(n => n[0]).join('').toUpperCase();
            }
            
            // Helper function to format message time
            function formatMessageTime(timestamp) {
                if (!timestamp) return '';
                
                const date = new Date(timestamp);
                const now = new Date();
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                
                // Same day
                if (date.toDateString() === now.toDateString()) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                // Yesterday
                else if (date.toDateString() === yesterday.toDateString()) {
                    return `Yesterday, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                }
                // This week
                else if (now.getTime() - date.getTime() < 7 * 24 * 60 * 60 * 1000) {
                    return `${date.toLocaleDateString([], { weekday: 'short' })}, ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                }
                // Older
                else {
                    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
                }
            }
            
            // Helper function to show error message
            function showError(message) {
                alert(message);
            }
            
            // Initialize on page load
            document.addEventListener('DOMContentLoaded', initMessaging);
        </script>
    </body>
</html>
