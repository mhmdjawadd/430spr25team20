<!doctype html>
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
    <title>AI Medical Assistant - Nabad</title>
    
    <link rel="icon" href="img/favicon.png">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Poppins:200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- Nice Select CSS -->
    <link rel="stylesheet" href="css/nice-select.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <!-- icofont CSS -->
    <link rel="stylesheet" href="css/icofont.css">
    <!-- Slicknav -->
    <link rel="stylesheet" href="css/slicknav.min.css">
    <!-- Owl Carousel CSS -->
    <link rel="stylesheet" href="css/owl-carousel.css">
    <!-- Datepicker CSS -->
    <link rel="stylesheet" href="css/datepicker.css">
    <!-- Animate CSS -->
    <link rel="stylesheet" href="css/animate.min.css">
    <!-- Magnific Popup CSS -->
    <link rel="stylesheet" href="css/magnific-popup.css">
    
    <!-- Medipro CSS -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/responsive.css">

    <style>
        /* Chat container styling */
        .chat-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            overflow: hidden;
            height: 500px;
            display: flex;
            flex-direction: column;
            margin-bottom: 30px;
        }
        
        .chat-header {
            background: #1A76D1;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        
        .message {
            margin-bottom: 15px;
            clear: both;
            overflow: hidden;
        }
        
        .user-message {
            float: right;
            background-color: #1A76D1;
            color: white;
            padding: 10px 15px;
            border-radius: 18px 18px 0 18px;
            max-width: 70%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .bot-message {
            float: left;
            background-color: #f1f0f0;
            padding: 10px 15px;
            border-radius: 18px 18px 18px 0;
            max-width: 70%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid #eee;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 16px;
        }
        
        .chat-input button {
            padding: 12px 25px;
            margin-left: 10px;
            background-color: #1A76D1;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .chat-input button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        
        .timestamp {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            display: block;
        }
        
        .loader {
            display: none;
            text-align: left;
            margin: 10px 0;
        }
        
        .loader span {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #1A76D1;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.5s infinite ease-in-out;
        }
        
        .loader span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .loader span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        
        .ai-features {
            margin-top: 30px;
        }
        
        .ai-feature-box {
            padding: 20px;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .ai-feature-box:hover {
            transform: translateY(-5px);
        }
        
        .ai-feature-box i {
            font-size: 40px;
            color: #1A76D1;
            margin-bottom: 15px;
        }
        
        .ai-feature-box h4 {
            color: #1A76D1;
            margin-bottom: 15px;
        }

        .logout-btn {
            color: #1a1a1a;
            font-size: 16px;
            font-weight: 500;
            transition: color 0.3s;
            margin-top: 20px;
        }

        .logout-btn:hover {
            color: #0066cc;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="preloader">
        <div class="loader">
            <div class="loader-outter"></div>
            <div class="loader-inner"></div>
            <div class="indicator"> 
                <svg width="16px" height="12px">
                    <polyline id="back" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
                    <polyline id="front" points="1 6 4 6 6 11 10 1 12 6 15 6"></polyline>
                </svg>
            </div>
        </div>
    </div>
  
    <header class="header">
        <div class="header-inner">
            <div class="container">
                <div class="inner">
                    <div class="row">
                        <div class="col-lg-3 col-md-3 col-12">
                            <div class="logo">
                                <a href="index.html"><img src="img/nabad.png" alt="#"></a>
                            </div>
                            <div class="mobile-nav"></div>
                        </div>
                        <div class="col-lg-9 col-md-9 col-12">
                            <div class="main-menu">
                                <nav class="navigation">
                                    <ul class="nav menu">
                                        <li><a href="doctors.html">Doctors</a></li>
                                        <li><a href="#" id="dashboardLink">Dashboard</a></li>
                                        <li><a href="appointments.html">Book Appointment</a></li>
                                        <li><a href="chatbot.html">AI Assistant</a></li>
                                        <li><a href="login.html" class="logout-btn" onclick="handleLogout()">
                                            <i class="fas fa-door-open"></i> 
                                        </a></li>
                                        <li class="nav-item user-greeting">
                                            <span id="userGreeting"></span>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="breadcrumbs overlay">
        <div class="container">
            <div class="bread-inner">
                <div class="row">
                    <div class="col-12">
                        <h2>AI Medical Assistant</h2>
                        <ul class="bread-list">
                            <li><a href="index.html">Home</a></li>
                            <li><i class="icofont-simple-right"></i></li>
                            <li class="active">AI Assistant</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <section class="appointment single-page">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="section-title">
                        <h2>Your Personal Medical Assistant</h2>
                        <img src="img/section-img.png" alt="#">
                        <p>Chat with our AI to book appointments, get doctor recommendations, and answer health questions</p>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-lg-8 col-md-12 col-12">
                    <div class="chat-container">
                        <div class="chat-header">
                            Nabad Medical Assistant
                        </div>
                        <div class="chat-messages" id="chat-messages">
                            <div class="message">
                                <div class="bot-message">
                                    Hello! I'm your Nabad medical assistant. How can I help you today?
                                    <span class="timestamp">Just now</span>
                                </div>
                            </div>
                            <div class="loader" id="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="user-input" placeholder="Type your message here..." />
                            <button id="send-button">Send</button>
                        </div>
                    </div>
                    
                    <div class="row ai-features">
                        <div class="col-lg-4 col-md-6">
                            <div class="ai-feature-box text-center">
                                <i class="fas fa-calendar-check"></i>
                                <h4>Book Appointments</h4>
                                <p>Schedule appointments with your preferred doctors</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="ai-feature-box text-center">
                                <i class="fas fa-user-md"></i>
                                <h4>Get Recommendations</h4>
                                <p>Find the right specialist for your needs</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="ai-feature-box text-center">
                                <i class="fas fa-info-circle"></i>
                                <h4>Health Information</h4>
                                <p>Get answers to common health questions</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 col-md-12 col-12">
                    <div class="appointment-image">
                        <img src="img/contact-img.png" alt="#">
                    </div>
                
                    <div class="work-hour">
                        <h3>Working Hours</h3>
                        <ul class="time-sidual">
                            <li class="day">Monday - Friday <span>8.00-20.00</span></li>
                            <li class="day">Saturday <span>9.00-18.30</span></li>
                            <li class="day">Sunday <span>9.00-15.00</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <footer id="footer" class="footer">
        <div class="footer-top">
            <div class="container">
                <div class="row">
                    <div class="col-lg-3 col-md-6 col-12">
                        <div class="single-footer">
                            <h2>About Us</h2>
                            <p>Nabad is the leading software booking system in the middle east</p>
                        
                            <ul class="social">
                                <li><a href="#"><i class="icofont-facebook"></i></a></li>
                                <li><a href="#"><i class="icofont-google-plus"></i></a></li>
                                <li><a href="#"><i class="icofont-twitter"></i></a></li>
                                <li><a href="#"><i class="icofont-vimeo"></i></a></li>
                                <li><a href="#"><i class="icofont-pinterest"></i></a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-12">
                        <div class="single-footer f-link">
                            <h2>Quick Links</h2>
                            <div class="row">
                                <div class="col-lg-6 col-md-6 col-12">
                                    <ul>
                                        <li><a href="index.html"><i class="fa fa-caret-right" aria-hidden="true"></i>Home</a></li>
                                        <li><a href="doctors.html"><i class="fa fa-caret-right" aria-hidden="true"></i>Doctors</a></li>
                                        <li><a href="services.html"><i class="fa fa-caret-right" aria-hidden="true"></i>Services</a></li>
                                        <li><a href="contact.html"><i class="fa fa-caret-right" aria-hidden="true"></i>Contact Us</a></li>    
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-12">
                        <div class="single-footer">
                            <h2>Open Hours</h2>
                            <ul class="time-sidual">
                                <li class="day">Monday - Friday <span>8.00-20.00</span></li>
                                <li class="day">Saturday <span>9.00-18.30</span></li>
                                <li class="day">Sunday <span>9.00-15.00</span></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 col-12">
                        <div class="single-footer">
                            <h2>Newsletter</h2>
                            <p>Subscribe to our newsletter to get all our news in your inbox.</p>
                            <form action="mail/mail.php" method="get" target="_blank" class="newsletter-inner">
                                <input name="email" placeholder="Email Address" class="common-input" type="email">
                                <button class="button"><i class="icofont icofont-paper-plane"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="copyright">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-12">
                        <div class="copyright-content">
                            <p>Â© Copyright 2024 | All Rights Reserved</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- jquery Min JS -->
    <script src="js/jquery.min.js"></script>
    <!-- jquery Migrate JS -->
    <script src="js/jquery-migrate-3.0.0.js"></script>
    <!-- jquery UI JS -->
    <script src="js/jquery-ui.min.js"></script>
    <!-- Easing JS -->
    <script src="js/easing.js"></script>
    <!-- Color JS -->
    <script src="js/colors.js"></script>
    <!-- Popper JS -->
    <script src="js/popper.min.js"></script>
    <!-- Bootstrap Datepicker JS -->
    <script src="js/bootstrap-datepicker.js"></script>
    <!-- Jquery Nav JS -->
    <script src="js/jquery.nav.js"></script>
    <!-- Slicknav JS -->
    <script src="js/slicknav.min.js"></script>
    <!-- ScrollUp JS -->
    <script src="js/jquery.scrollUp.min.js"></script>
    <!-- Niceselect JS -->
    <script src="js/niceselect.js"></script>
    <!-- Tilt Jquery JS -->
    <script src="js/tilt.jquery.min.js"></script>
    <!-- Owl Carousel JS -->
    <script src="js/owl-carousel.js"></script>
    <!-- counterup JS -->
    <script src="js/jquery.counterup.min.js"></script>
    <!-- Steller JS -->
    <script src="js/steller.js"></script>
    <!-- Wow JS -->
    <script src="js/wow.min.js"></script>
    <!-- Magnific Popup JS -->
    <script src="js/jquery.magnific-popup.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="js/bootstrap.min.js"></script>
    <!-- Main JS -->
    <script src="js/main.js"></script>

    <script>
        async function getCurrentUserProfile() {
            // Implementation of your getCurrentUserProfile function
            // This would fetch the user profile from your backend
            try {
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                if (!token) {
                    throw new Error('No token found');
                }
                
                const response = await fetch('http://localhost:5000/users/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch profile');
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error fetching profile:', error);
                return null;
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('token');
                sessionStorage.removeItem('token');
                window.location.href = 'login.html';
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const userGreetingElement = document.getElementById('userGreeting');
            const dashboardLink = document.getElementById('dashboardLink');
            
            try {
                const user = await getCurrentUserProfile();
                
                // Update greeting
                let displayName;
                if (user && user.first_name) {
                    displayName = user.first_name;
                } else if (user && user.email) {
                    displayName = user.email.split('@')[0];
                } else {
                    displayName = 'Guest';
                }
                userGreetingElement.innerHTML = `<i class="fas fa-user-circle"></i> Hi, ${displayName}!`;
                
                // Set dashboard redirect based on role
                if (user && user.role) {
                    if (user.role.toLowerCase() === 'doctor') {
                        dashboardLink.href = './Doctor Dashboard/doctor-dashboard.html';
                    } else {
                        dashboardLink.href = './Patient Dashboard/patient_dashboard.html';
                    }
                } else {
                    // Default to patient dashboard if role is not defined
                    dashboardLink.href = './Patient Dashboard/patient_dashboard.html';
                }
                
                console.log('User profile loaded:', user);
            } catch (error) {
                console.error('Error loading user profile:', error);
                userGreetingElement.innerHTML = `<i class="fas fa-user-circle"></i> Hi, Guest!`;
                dashboardLink.href = 'login.html'; // Redirect to login if can't get profile
            }
        });
    
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const typingIndicator = document.getElementById('typing-indicator');
            
            // API base URL - change this to match your backend server
            const API_BASE_URL = "http://localhost:5000";
    
            // Function to get auth token from localStorage or sessionStorage
            function getAuthToken() {
                return localStorage.getItem('token') || sessionStorage.getItem('token');
            }
    
            // Function to format timestamp
            function formatTimestamp() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }
    
            // Function to display messages
            function displayMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
    
                const messageContent = document.createElement('div');
                messageContent.className = sender === 'user' ? 'user-message' : 'bot-message';
                messageContent.textContent = text;
    
                const timestamp = document.createElement('span');
                timestamp.className = 'timestamp';
                timestamp.textContent = formatTimestamp();
                messageContent.appendChild(timestamp);
    
                messageDiv.appendChild(messageContent);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
    
            // Function to show typing indicator
            function showTypingIndicator() {
                typingIndicator.style.display = 'block';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
    
            // Function to hide typing indicator
            function hideTypingIndicator() {
                typingIndicator.style.display = 'none';
            }
    
            // Function to send message to chatbot API
            async function sendToChatbot(message) {
                const token = getAuthToken();
                if (!token) {
                    displayMessage('Please log in to use the chatbot.', 'bot');
                    return;
                }
    
                showTypingIndicator();
    
                try {
                    console.log(`Sending request to ${API_BASE_URL}/ai/chat`);
                    console.log('Request payload:', { query: message });
                    console.log('Auth token:', token);
    
                    const response = await fetch(`${API_BASE_URL}/ai/chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ query: message })
                    });
                    
                    hideTypingIndicator();
    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        throw new Error(`Request failed: ${response.status} - ${errorText}`);
                    }
    
                    // Read the response as text first to log it
                    const responseText = await response.text();
                    console.log('Raw response:', responseText);
                    
                    // Then parse it as JSON
                    const data = responseText ? JSON.parse(responseText) : {};
                    console.log('Parsed response:', data);
                    
                    if (data.status === 'success') {
                        // Handle different response formats from the coordinator
                        if (data.response && typeof data.response === 'string') {
                            displayMessage(data.response, 'bot');
                        } else if (data.message && typeof data.message === 'string') {
                            displayMessage(data.message, 'bot');
                        } else if (data.message && typeof data.message === 'object') {
                            // Handle case where message is an object (like doctor recommendation)
                            const message = data.message;
                            let formattedMessage = `I recommend Dr. ${message.doctor_name}\n\nReason: ${message.reason}`;
                            displayMessage(formattedMessage, 'bot');
                        } else if (data.recommendation) {
                            const rec = data.recommendation;
                            const recMessage = `I recommend Dr. ${rec.doctor_name} (ID: ${rec.doctor_id}).\n\nReason: ${rec.reason}`;
                            displayMessage(recMessage, 'bot');
                        } else {
                            displayMessage('I processed your request successfully.', 'bot');
                        }
                    } else {
                        displayMessage(`Sorry, I encountered an error: ${data.message || 'Unknown error'}`, 'bot');
                        console.error('Error:', data);
                    }
                } catch (error) {
                    hideTypingIndicator();
                    displayMessage(`Sorry, there was a problem connecting to the service: ${error.message}`, 'bot');
                    console.error('Error:', error);
                }
            }
    
            // Function to handle send button click or Enter key press
            function handleSendMessage() {
                const message = userInput.value.trim();
                if (message) {
                    displayMessage(message, 'user');
                    userInput.value = '';
                    sendToChatbot(message);
                }
            }
    
            // Event listeners
            sendButton.addEventListener('click', handleSendMessage);
            userInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    handleSendMessage();
                }
            });
    
            // Focus on input field when the page loads
            userInput.focus();
        });
    </script>
</body>
</html>